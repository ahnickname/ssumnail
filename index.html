<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›¹ëƒ¥ì´ ì¸ë„¤ì¼ ë©”ì´ì»¤ V6 (ìµœì¢…)</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #1a1a1a; --point-color: #00d2d3; --text-color: #fff; }
        body { margin: 0; padding: 20px; font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; }
        h1 { color: var(--point-color); margin-bottom: 10px; font-family: 'Black Han Sans', sans-serif; letter-spacing: 1px; }
        .controls { background: #333; padding: 20px; border-radius: 10px; margin-bottom: 20px; width: 100%; max-width: 900px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        input[type="file"], button, input[type="text"] { padding: 12px; border-radius: 5px; border: none; font-family: 'Black Han Sans', sans-serif; cursor: pointer; }
        input[type="text"] { width: 200px; }
        button { background: var(--point-color); color: #222; transition: 0.3s; font-size: 1rem; }
        button:hover { transform: scale(1.05); filter: brightness(1.1); }
        #canvas-container { box-shadow: 0 10px 30px rgba(0,0,0,0.8); border: 2px solid #444; border-radius: 5px; }
        .loading { display: none; margin: 20px; color: var(--point-color); font-weight: bold; font-size: 1.2em; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.0.4/dist/imgly-background-removal.min.js"></script>
</head>
<body>

    <h1>ğŸ± ì›¹ëƒ¥ì´ ì¸ë„¤ì¼ ë©”ì´ì»¤ V6</h1>
    <p>ì–´ë–¤ íŒŒì¼ì´ë“  ë‹¤ ë°›ì•„ì¤ë‹ˆë‹¤! (ì˜ì–´ ë³€í™˜ + ìë™ ë¦¬ì‚¬ì´ì§•)</p>

    <div class="controls">
        <input type="file" id="imgLoader" multiple accept="image/*">
        <input type="text" id="textInput" placeholder="ë¬¸êµ¬ ì…ë ¥ (ì˜ˆ: ë ˆì „ë“œ)">
        <button onclick="addText()">ğŸ…°ï¸ ê¸€ì”¨ ë„£ê¸°</button>
        <button onclick="downloadImage()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        <button onclick="clearCanvas()" style="background:#ff5f5f; color:white;">âœ¨ ì´ˆê¸°í™”</button>
    </div>
    
    <div class="loading" id="loadingMsg">â³ AIê°€ ì‚¬ì§„ì„ ì†ì§ˆí•˜ê³  ìˆì–´ìš”...</div>

    <div id="canvas-container">
        <canvas id="c" width="1280" height="720"></canvas>
    </div>

    <script>
        const canvas = new fabric.Canvas('c');
        // ìœ íŠœë¸Œ ê°ì„± ë°°ê²½ ê·¸ë¼ë°ì´ì…˜
        const bgGradient = new fabric.Gradient({
            type: 'linear',
            coords: { x1: 0, y1: 0, x2: 1280, y2: 720 },
            colorStops: [
                { offset: 0, color: '#2b32b2' },
                { offset: 1, color: '#1488cc' }
            ]
        });
        canvas.setBackgroundColor(bgGradient, canvas.renderAll.bind(canvas));
        
        let imageCount = 0;

        // [í•µì‹¬ 1] ì´ë¯¸ì§€ë¥¼ ì ë‹¹í•œ í¬ê¸°(1000px)ë¡œ ì¤„ì—¬ì£¼ëŠ” í•¨ìˆ˜ (ë©”ëª¨ë¦¬ ì ˆì•½)
        function resizeImage(file) {
            return new Promise((resolve) => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const tempCanvas = document.createElement('canvas');
                    const ctx = tempCanvas.getContext('2d');
                    const maxSize = 1000; // ì´ë³´ë‹¤ í¬ë©´ ë¬´ì¡°ê±´ ì¤„ì„
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                    } else {
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    }
                    tempCanvas.width = width;
                    tempCanvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    tempCanvas.toBlob((blob) => {
                        // [í•µì‹¬ 2] íŒŒì¼ ì´ë¦„ì„ ë¬´ì¡°ê±´ ì˜ì–´(image.png)ë¡œ ê°•ì œ ë³€ê²½!
                        const safeName = `image_${Date.now()}.png`;
                        resolve(new File([blob], safeName, { type: "image/png" }));
                    }, 'image/png', 0.9);
                };
            });
        }

        document.getElementById('imgLoader').addEventListener('change', async function(e) {
            const files = e.target.files;
            if (!files.length) return;

            const loadingMsg = document.getElementById('loadingMsg');
            loadingMsg.style.display = 'block';

            for (let i = 0; i < files.length; i++) {
                try {
                    loadingMsg.innerText = `ğŸ”¨ ${files[i].name} ì†ì§ˆ ì¤‘... (${i+1}/${files.length})`;
                    
                    // 1. í¬ê¸° ì¤„ì´ê³  + ì˜ì–´ ì´ë¦„ìœ¼ë¡œ ë°”ê¾¸ê¸°
                    const safeFile = await resizeImage(files[i]);
                    
                    loadingMsg.innerText = `ğŸ¤– ë°°ê²½ ì§€ìš°ëŠ” ì¤‘... (${i+1}/${files.length})`;

                    // 2. AIì—ê²Œ ë„˜ê¸°ê¸°
                    const config = { publicPath: "https://cdn.jsdelivr.net/npm/@imgly/background-removal-data@1.0.4/dist/" };
                    const blob = await imglyRemoveBackground(safeFile, config);
                    const url = URL.createObjectURL(blob);

                    fabric.Image.fromURL(url, function(img) {
                        if (img.width > 500) img.scaleToWidth(450);
                        img.set({
                            left: 100 + (imageCount * 250), // ì˜†ìœ¼ë¡œ ì°©ì°© ë°°ì¹˜
                            top: canvas.height / 2 - (img.getScaledHeight() / 2),
                            shadow: new fabric.Shadow({ color: "rgba(0,0,0,0.5)", blur: 20, offsetX: 5, offsetY: 5 })
                        });
                        canvas.add(img);
                        img.animate('scaleX', 1.1, { onChange: canvas.renderAll.bind(canvas), duration: 100, onComplete: function() { img.animate('scaleX', 1, { onChange: canvas.renderAll.bind(canvas), duration: 100 }); } }); // ë“±ì¥ íš¨ê³¼
                        imageCount++;
                    });
                } catch (error) {
                    console.error(error);
                    alert("ì´ëŸ°, ì•„ì£¼ ê°•ë ¥í•œ ì‚¬ì§„ì´êµ°ìš”. ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ã… ã… ");
                }
            }
            loadingMsg.style.display = 'none';
            e.target.value = ''; // ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì˜¬ë ¤ë„ ë˜ê²Œ ì´ˆê¸°í™”
        });

        function addText() {
            const textVal = document.getElementById('textInput').value;
            if (!textVal) return;
            const text = new fabric.Text(textVal, {
                left: canvas.width / 2, top: 100, originX: 'center',
                fontFamily: '"Black Han Sans", sans-serif', fontSize: 130,
                fill: '#fff000', stroke: '#000', strokeWidth: 8,
                shadow: new fabric.Shadow({ color: "#000", blur: 0, offsetX: 8, offsetY: 8 })
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        function downloadImage() {
            const dataURL = canvas.toDataURL({ format: 'png', quality: 1.0 });
            const link = document.createElement('a');
            link.download = 'thumbnail_v6.png';
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function clearCanvas() {
            canvas.clear();
            canvas.setBackgroundColor(bgGradient, canvas.renderAll.bind(canvas));
            imageCount = 0;
        }

        window.addEventListener('keydown', (e) => { if(e.key === 'Delete') { const act = canvas.getActiveObjects(); if(act.length) { canvas.discardActiveObject(); act.forEach((o) => canvas.remove(o)); } } });
    </script>
</body>
</html>
