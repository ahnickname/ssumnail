<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›¹ëƒ¥ì´ì˜ ì¸ë„¤ì¼ ë©”ì´ì»¤ (Final)</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #1a1a1a; --point-color: #00d2d3; --text-color: #fff; }
        body { margin: 0; padding: 20px; font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; }
        h1 { color: var(--point-color); margin-bottom: 10px; font-family: 'Black Han Sans', sans-serif; }
        .controls { background: #333; padding: 20px; border-radius: 10px; margin-bottom: 20px; width: 100%; max-width: 900px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        input[type="file"], button, input[type="text"] { padding: 12px; border-radius: 5px; border: none; font-family: 'Black Han Sans', sans-serif; cursor: pointer; }
        button { background: var(--point-color); color: #222; transition: 0.3s; }
        button:hover { transform: scale(1.05); }
        #canvas-container { box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .loading { display: none; margin: 20px; color: var(--point-color); font-weight: bold; font-size: 1.2em; }
    </style>
    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.0.4/dist/imgly-background-removal.min.js"></script>
</head>
<body>

    <h1>ğŸ± ì›¹ëƒ¥ì´ ì¸ë„¤ì¼ ë©”ì´ì»¤ (ì•ˆì „ëª¨ë“œ)</h1>
    <p>ì‚¬ì§„ í¬ê¸°ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì ˆí•´ì„œ ì˜¤ë¥˜ë¥¼ ë§‰ìŠµë‹ˆë‹¤!</p>

    <div class="controls">
        <input type="file" id="imgLoader" multiple accept="image/*">
        <input type="text" id="textInput" placeholder="ë¬¸êµ¬ ì…ë ¥">
        <button onclick="addText()">ê¸€ì”¨ ë„£ê¸°</button>
        <button onclick="downloadImage()">ì €ì¥í•˜ê¸°</button>
    </div>
    
    <div class="loading" id="loadingMsg">ğŸ¾ ì‚¬ì§„ ë‹¤ì´ì–´íŠ¸ ì‹œí‚¤ëŠ” ì¤‘...</div>

    <div id="canvas-container">
        <canvas id="c" width="1280" height="720"></canvas>
    </div>

    <script>
        const canvas = new fabric.Canvas('c');
        canvas.backgroundColor = '#222';
        canvas.renderAll();
        let imageCount = 0;

        // [í•µì‹¬ ê¸°ëŠ¥] ì´ë¯¸ì§€ë¥¼ ì‘ê²Œ ì¤„ì—¬ì£¼ëŠ” í•¨ìˆ˜ (ì†Œí™”ì œ)
        function resizeImage(file) {
            return new Promise((resolve) => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    // ìµœëŒ€ í¬ê¸°ë¥¼ 1000pxë¡œ ì œí•œ (ì´ëŸ¬ë©´ AIê°€ ì˜ ë¨¹ì–´ìš”)
                    const maxSize = 1000; 
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                    } else {
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((blob) => {
                        resolve(new File([blob], file.name, { type: "image/png" }));
                    }, 'image/png', 0.9);
                };
            });
        }

        document.getElementById('imgLoader').addEventListener('change', async function(e) {
            const files = e.target.files;
            if (!files.length) return;

            const loadingMsg = document.getElementById('loadingMsg');
            loadingMsg.style.display = 'block';

            for (let i = 0; i < files.length; i++) {
                try {
                    let file = files[i];
                    loadingMsg.innerText = `â³ ${file.name} í¬ê¸° ì¤„ì´ëŠ” ì¤‘...`;
                    
                    // 1. ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì‘ê²Œ ì¤„ì…ë‹ˆë‹¤.
                    const resizedFile = await resizeImage(file);
                    
                    loadingMsg.innerText = `âœ‚ï¸ ë°°ê²½ ìë¥´ëŠ” ì¤‘... (${i+1}/${files.length})`;

                    // 2. ì‘ì•„ì§„ ì´ë¯¸ì§€ë¥¼ AIì—ê²Œ ì¤ë‹ˆë‹¤.
                    const config = { publicPath: "https://cdn.jsdelivr.net/npm/@imgly/background-removal-data@1.0.4/dist/" };
                    const blob = await imglyRemoveBackground(resizedFile, config);
                    const url = URL.createObjectURL(blob);

                    fabric.Image.fromURL(url, function(img) {
                        if (img.width > 500) img.scaleToWidth(400);
                        img.set({
                            left: 200 + (imageCount * 150),
                            top: 200 + (imageCount * 50)
                        });
                        canvas.add(img);
                        imageCount++;
                    });
                } catch (error) {
                    console.error(error);
                    // ì‹¤íŒ¨í•´ë„ ì¡°ìš©íˆ ë„˜ì–´ê°€ê¸°
                }
            }
            loadingMsg.style.display = 'none';
        });

        function addText() {
            const textVal = document.getElementById('textInput').value;
            if (!textVal) return;
            const text = new fabric.Text(textVal, {
                left: 640, top: 360, originX: 'center', originY: 'center',
                fontFamily: '"Black Han Sans", sans-serif', fontSize: 100, fill: '#00d2d3', stroke: 'black', strokeWidth: 4
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }
        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'thumbnail.png';
            link.href = canvas.toDataURL({ format: 'png' });
            link.click();
        }
    </script>
</body>
</html>
