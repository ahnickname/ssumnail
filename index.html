<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›¹ëƒ¥ì´ì˜ ì¸ë„¤ì¼ ë©”ì´ì»¤ V4</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #1a1a1a; --point-color: #ffce44; --text-color: #fff; }
        body { margin: 0; padding: 20px; font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; }
        h1 { color: var(--point-color); margin-bottom: 10px; font-family: 'Black Han Sans', sans-serif; letter-spacing: 2px; }
        .controls { background: #333; padding: 20px; border-radius: 10px; margin-bottom: 20px; width: 100%; max-width: 900px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; }
        input[type="file"] { padding: 10px; background: #444; border-radius: 5px; color: #ddd; }
        input[type="text"] { padding: 12px; border-radius: 5px; border: none; font-size: 1.1em; width: 250px; font-family: 'Black Han Sans', sans-serif; }
        button { padding: 12px 24px; background: var(--point-color); color: black; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1.1em; transition: 0.3s; font-family: 'Black Han Sans', sans-serif; }
        button:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(255, 206, 68, 0.4); }
        #canvas-container { box-shadow: 0 10px 30px rgba(0,0,0,0.8); border-radius: 10px; overflow: hidden; }
        .loading { display: none; margin: 20px 0; color: var(--point-color); font-weight: bold; font-size: 1.2em; animation: blink 1.5s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        @media (max-width: 700px) { .controls { flex-direction: column; } input[type="text"] { width: 90%; } }
    </style>
    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.0.4/dist/imgly-background-removal.min.js"></script>
</head>
<body>

    <h1>âš¡ ì›¹ëƒ¥ì´ ì¸ë„¤ì¼ ë©”ì´ì»¤ V4</h1>
    <p>ì—¬ëŸ¬ ì¥ì„ ì˜¬ë¦¬ë©´ ì•Œì•„ì„œ í¼ì³ì¤ë‹ˆë‹¤! ê¸€ì”¨ë„ ë” ì˜ˆë»ì¡Œì–´ìš”.</p>

    <div class="controls">
        <input type="file" id="imgLoader" multiple accept="image/*">
        <input type="text" id="textInput" placeholder="ë¬¸êµ¬ ì…ë ¥ (ì˜ˆ: ì—­ëŒ€ê¸‰!!)">
        <button onclick="addText()" style="background:#fff; color:black;">ğŸ…°ï¸ ê¸€ì”¨ ë„£ê¸°</button>
        <button onclick="downloadImage()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        <button onclick="clearCanvas()" style="background:#ff5f5f; color:white;">âœ¨ ì „ì²´ ì§€ìš°ê¸°</button>
    </div>
    
    <div class="loading" id="loadingMsg">ğŸ¾ AIê°€ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>

    <div id="canvas-container">
        <canvas id="c" width="1280" height="720"></canvas>
    </div>

    <script>
        const canvas = new fabric.Canvas('c');
        
        // ë°°ê²½ì„ ì¢€ ë” ëŠë‚Œ ìˆëŠ” ê·¸ë¼ë°ì´ì…˜ìœ¼ë¡œ ë³€ê²½
        const bgGradient = new fabric.Gradient({
            type: 'linear',
            coords: { x1: 0, y1: 0, x2: 1280, y2: 720 },
            colorStops: [
                { offset: 0, color: '#2c3e50' },
                { offset: 1, color: '#000000' }
            ]
        });
        canvas.setBackgroundColor(bgGradient, canvas.renderAll.bind(canvas));

        let imageCount = 0; // ì˜¬ë¼ê°„ ì´ë¯¸ì§€ ê°œìˆ˜ ì„¸ê¸°

        document.getElementById('imgLoader').addEventListener('change', async function(e) {
            const files = e.target.files;
            if (!files.length) return;

            const loadingMsg = document.getElementById('loadingMsg');
            loadingMsg.style.display = 'block';
            
            // [í•µì‹¬ 2] ì—¬ëŸ¬ ì¥ ì˜¬ë¦´ ë•Œ ìë™ ë°°ì¹˜ë¥¼ ìœ„í•œ ê³„ì‚°
            const startX = 200; // ì²« ì´ë¯¸ì§€ ì‹œì‘ ìœ„ì¹˜
            const spacing = 300; // ì´ë¯¸ì§€ ê°„ê²©

            for (let i = 0; i < files.length; i++) {
                let file = files[i];
                try {
                    loadingMsg.innerText = `â³ ${file.name} ë°°ê²½ ë”°ëŠ” ì¤‘... (${i+1}/${files.length})`;
                    
                    // í•œê¸€ íŒŒì¼ëª… ì˜¤ë¥˜ ë°©ì§€
                    const safeName = `image_${Date.now()}_${i}.png`;
                    const safeFile = new File([file], safeName, { type: file.type });
                    
                    const config = { publicPath: "https://cdn.jsdelivr.net/npm/@imgly/background-removal-data@1.0.4/dist/" };
                    const blob = await imglyRemoveBackground(safeFile, config);
                    const url = URL.createObjectURL(blob);

                    fabric.Image.fromURL(url, function(img) {
                        // ì´ë¯¸ì§€ í¬ê¸° ì ë‹¹íˆ ì¡°ì ˆ
                        if (img.width > 600) img.scaleToWidth(500);
                        if (img.height > 600) img.scaleToHeight(500);

                        // [í•µì‹¬ 2 êµ¬í˜„] ìˆœì„œëŒ€ë¡œ ì˜†ìœ¼ë¡œ ì°©ì°© í¼ì³ì„œ ë°°ì¹˜
                        img.set({
                            left: startX + (imageCount * spacing), // ê°œìˆ˜ì— ë”°ë¼ ì˜†ìœ¼ë¡œ ì´ë™
                            top: canvas.height / 2 - (img.getScaledHeight() / 2) + (imageCount * 30), // ì•½ê°„ì”© ì•„ë˜ë¡œ
                            shadow: new fabric.Shadow({ color: "rgba(0,0,0,0.5)", blur: 20, offsetX: 10, offsetY: 10 }) // ê·¸ë¦¼ì ì¶”ê°€
                        });

                        canvas.add(img);
                        canvas.setActiveObject(img);
                        imageCount++; // ê°œìˆ˜ ì¦ê°€
                    });
                } catch (error) {
                    console.error(error);
                    alert(`${file.name} ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ ã… ã… `);
                }
            }
            loadingMsg.style.display = 'none';
            // íŒŒì¼ ì…ë ¥ì°½ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì˜¬ë¦´ ìˆ˜ ìˆê²Œ)
            e.target.value = ''; 
        });

        function addText() {
            const textVal = document.getElementById('textInput').value;
            if (!textVal) return;
            
            // [í•µì‹¬ 1 êµ¬í˜„] í°íŠ¸ë¥¼ 'Black Han Sans'ë¡œ ë³€ê²½í•˜ê³  ìŠ¤íƒ€ì¼ ê°•í™”
            const text = new fabric.Text(textVal, {
                left: canvas.width / 2, top: 100, originX: 'center',
                fontFamily: '"Black Han Sans", sans-serif', // <-- ì—¬ê¸°!
                fontSize: 120,
                fill: '#ffce44', // ë…¸ë€ìƒ‰ ì±„ìš°ê¸°
                stroke: '#000', // ê²€ì€ìƒ‰ í…Œë‘ë¦¬
                strokeWidth: 6, // í…Œë‘ë¦¬ ë‘ê»˜
                shadow: new fabric.Shadow({ color: "#000", blur: 0, offsetX: 8, offsetY: 8 }) // ë”±ë”±í•œ ê·¸ë¦¼ì íš¨ê³¼
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        function downloadImage() {
            const dataURL = canvas.toDataURL({ format: 'png', quality: 1.0 });
            const link = document.createElement('a');
            link.download = 'thumbnail_v4.png';
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function clearCanvas() {
            if(confirm('ìº”ë²„ìŠ¤ë¥¼ ëª¨ë‘ ì§€ìš¸ê¹Œìš”?')) {
                canvas.clear();
                canvas.setBackgroundColor(bgGradient, canvas.renderAll.bind(canvas));
                imageCount = 0;
            }
        }

        window.addEventListener('keydown', (e) => {
            if(e.key === 'Delete') {
                const activeObjects = canvas.getActiveObjects();
                if (activeObjects.length) {
                    canvas.discardActiveObject();
                    activeObjects.forEach((obj) => canvas.remove(obj));
                }
            }
        });
    </script>
</body>
</html>
